/*
Deployment script for ObservationsTest

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ObservationsTest"
:setvar DefaultFilePrefix "ObservationsTest"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.SAEON\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.SAEON\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF (SELECT is_default
    FROM   [$(DatabaseName)].[sys].[filegroups]
    WHERE  [name] = N'Documents') = 0
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            MODIFY FILEGROUP [Documents] DEFAULT;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[FK_UserDownloads_AspNetUsers_AddedBy]...';


GO
ALTER TABLE [dbo].[UserDownloads] DROP CONSTRAINT [FK_UserDownloads_AspNetUsers_AddedBy];


GO
PRINT N'Dropping [dbo].[FK_UserDownloads_AspNetUsers_UpdatedBy]...';


GO
ALTER TABLE [dbo].[UserDownloads] DROP CONSTRAINT [FK_UserDownloads_AspNetUsers_UpdatedBy];


GO
PRINT N'Dropping [dbo].[FK_UserDownloads_AspNetUsers_UserId]...';


GO
ALTER TABLE [dbo].[UserDownloads] DROP CONSTRAINT [FK_UserDownloads_AspNetUsers_UserId];


GO
PRINT N'Dropping [dbo].[FK_UserQueries_AspNetUsers_AddedBy]...';


GO
ALTER TABLE [dbo].[UserQueries] DROP CONSTRAINT [FK_UserQueries_AspNetUsers_AddedBy];


GO
PRINT N'Dropping [dbo].[FK_UserQueries_AspNetUsers_UpdatedBy]...';


GO
ALTER TABLE [dbo].[UserQueries] DROP CONSTRAINT [FK_UserQueries_AspNetUsers_UpdatedBy];


GO
PRINT N'Dropping [dbo].[FK_UserQueries_AspNetUsers_UserId]...';


GO
ALTER TABLE [dbo].[UserQueries] DROP CONSTRAINT [FK_UserQueries_AspNetUsers_UserId];


GO
PRINT N'Dropping [dbo].[UX_Observation]...';


GO
ALTER TABLE [dbo].[Observation] DROP CONSTRAINT [UX_Observation];


GO
PRINT N'Altering [dbo].[UserDownloads]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
ALTER TABLE [dbo].[UserDownloads] ALTER COLUMN [Description] VARCHAR (5000) NULL;


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering [dbo].[vObservationRoles]...';


GO
--> Changed 2.0.3 20160503 TimPN
--Renamed SensorProcedure to Sensor
--< Changed 2.0.3 20160503 TimPN
ALTER VIEW [dbo].[vObservationRoles]
AS
--> Changed 2.0.16 20161107 TimPN
----> Changed 2.0.3 20160421 TimPN
----SELECT     vo.ID, vo.SensorID, vo.PhenonmenonOfferingID, vo.PhenonmenonUOMID, vo.UserId, vo.RawValue, vo.DataValue, vo.ImportBatchID, vo.ValueDate, 
--SELECT     vo.ID, vo.SensorID, vo.PhenomenonOfferingID, vo.PhenomenonUOMID, vo.UserId, vo.RawValue, vo.DataValue, vo.ImportBatchID, vo.ValueDate, 
----> Changed 2.0.3 20160421 TimPN
--                      vo.spCode, vo.spDesc, vo.spName, vo.spURL, vo.DataSchemaID, vo.DataSourceID, vo.PhenomenonID, vo.StationID, vo.phName, vo.stName, vo.dsName, 
--                      vo.dschemaName, vo.offName, vo.offID, vo.psName, vo.psID, vo.orgName, vo.orgID, vo.uomUnit, vo.uomSymbol, vo.UserName,
--                      dr.DataSourceID AS Expr2, dr.DateStart, dr.DateEnd,
--                      ur.UserId AS Expr5, vo.Comment
--FROM         dbo.vObservation AS vo 
--INNER JOIN 
--(
-- SELECT dr.DataSourceID,
--        ur.UserId,
--        MIN(dr.DateStart) DateStart,
--        MAX(dr.DateEnd) DateEnd
-- FROM DataSourceRole dr
-- INNER JOIN    dbo.aspnet_Roles AS ar ON dr.RoleId = ar.RoleId INNER JOIN
--               dbo.aspnet_UsersInRoles AS ur ON ar.RoleId = ur.RoleId
-- GROUP By dr.DataSourceID,ur.UserId
--) dr
--ON vo.DataSourceID = dr.DataSourceID 
--AND vo.ValueDate >= dr.DateStart AND vo.ValueDate <= dr.DateEnd
--INNER JOIN aspnet_Users ur
-- ON dr.UserId = ur.UserId
    Select
--> Changed 20170213 TimPN
--        vObservation.*, DataSourceRoles.RoleUserId
      vObservation.*, DataSourceRoles.RoleUserId, DataSourceRoles.DateStart RoleStartDate, DataSourceRoles.DateEnd RoleEndDate
--< Changed 20170213 TimPN
    from
        vObservation
--> Changed 20170213 TimPN
--        inner join
        left join
--< Changed 20170213 TimPN
        (
            Select
                dsr.DataSourceID, aspnet_UsersInRoles.UserId RoleUserId, Min(dsr.DateStart) DateStart, Max(dsr.DateEnd) DateEnd
            from
                DataSourceRole dsr
            inner join aspnet_UsersInRoles
                on (dsr.RoleId = aspnet_UsersInRoles.RoleId)
            group by
                dsr.DataSourceID, aspnet_UsersInRoles.UserId
        ) DataSourceRoles
--> Changed 20170213 TimPN
        --on (vObservation.DataSourceID = DataSourceRoles.DataSourceID) and
        --   (vObservation.ValueDate >= DataSourceRoles.DateStart) and 
        --   (vObservation.ValueDate <= DataSourceRoles.DateEnd)
          on (vObservation.DataSourceID = DataSourceRoles.DataSourceID) 
        where
           ((DataSourceRoles.DateStart is null) or (vObservation.ValueDate >= DataSourceRoles.DateStart)) and 
           ((DataSourceRoles.DateEnd is null) or (vObservation.ValueDate <= DataSourceRoles.DateEnd))
--< Changed 20170213 TimPN
--< Changed 2.0.16 20161107 TimPN
GO
PRINT N'Update complete.';


GO
