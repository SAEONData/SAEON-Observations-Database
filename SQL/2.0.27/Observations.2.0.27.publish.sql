/*
Deployment script for Observations

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Observations"
:setvar DefaultFilePrefix "Observations"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.SAEON\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.SAEON\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF (SELECT is_default
    FROM   [$(DatabaseName)].[sys].[filegroups]
    WHERE  [name] = N'Documents') = 0
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            MODIFY FILEGROUP [Documents] DEFAULT;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[DF_Organisation_ID]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [DF_Organisation_ID];


GO
PRINT N'Dropping [dbo].[DF_Organisation_UpdatedAt]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [DF_Organisation_UpdatedAt];


GO
PRINT N'Dropping [dbo].[DF_Organisation_AddedAt]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [DF_Organisation_AddedAt];


GO
PRINT N'Dropping [dbo].[DF_Organisation_Instrument_UpdatedAt]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [DF_Organisation_Instrument_UpdatedAt];


GO
PRINT N'Dropping [dbo].[DF_Organisation_Instrument_AddedAt]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [DF_Organisation_Instrument_AddedAt];


GO
PRINT N'Dropping [dbo].[DF_Organisation_Instrument_ID]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [DF_Organisation_Instrument_ID];


GO
PRINT N'Dropping [dbo].[FK_Organisation_Site_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation_Site] DROP CONSTRAINT [FK_Organisation_Site_Organisation];


GO
PRINT N'Dropping [dbo].[FK_Organisation_Station_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation_Station] DROP CONSTRAINT [FK_Organisation_Station_Organisation];


GO
PRINT N'Dropping [dbo].[FK_ProjectSite_Organisation]...';


GO
ALTER TABLE [dbo].[ProjectSite] DROP CONSTRAINT [FK_ProjectSite_Organisation];


GO
PRINT N'Dropping [dbo].[FK_Organisation_Instrument_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [FK_Organisation_Instrument_Organisation];


GO
PRINT N'Dropping [dbo].[FK_Organisation_aspnet_Users]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [FK_Organisation_aspnet_Users];


GO
PRINT N'Dropping [dbo].[FK_Organisation_Instrument_Instrument]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [FK_Organisation_Instrument_Instrument];


GO
PRINT N'Dropping [dbo].[FK_Organisation_Instrument_OrganisationRole]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [FK_Organisation_Instrument_OrganisationRole];


GO
PRINT N'Dropping [dbo].[FK_Organisation_Instrument_aspnet_Users]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [FK_Organisation_Instrument_aspnet_Users];


GO
PRINT N'Dropping [dbo].[FK_UserDownloads_AspNetUsers_AddedBy]...';


GO
ALTER TABLE [dbo].[UserDownloads] DROP CONSTRAINT [FK_UserDownloads_AspNetUsers_AddedBy];


GO
PRINT N'Dropping [dbo].[FK_UserDownloads_AspNetUsers_UpdatedBy]...';


GO
ALTER TABLE [dbo].[UserDownloads] DROP CONSTRAINT [FK_UserDownloads_AspNetUsers_UpdatedBy];


GO
PRINT N'Dropping [dbo].[FK_UserDownloads_AspNetUsers_UserId]...';


GO
ALTER TABLE [dbo].[UserDownloads] DROP CONSTRAINT [FK_UserDownloads_AspNetUsers_UserId];


GO
PRINT N'Dropping [dbo].[FK_UserQueries_AspNetUsers_AddedBy]...';


GO
ALTER TABLE [dbo].[UserQueries] DROP CONSTRAINT [FK_UserQueries_AspNetUsers_AddedBy];


GO
PRINT N'Dropping [dbo].[FK_UserQueries_AspNetUsers_UpdatedBy]...';


GO
ALTER TABLE [dbo].[UserQueries] DROP CONSTRAINT [FK_UserQueries_AspNetUsers_UpdatedBy];


GO
PRINT N'Dropping [dbo].[FK_UserQueries_AspNetUsers_UserId]...';


GO
ALTER TABLE [dbo].[UserQueries] DROP CONSTRAINT [FK_UserQueries_AspNetUsers_UserId];


GO
PRINT N'Dropping [dbo].[UX_Observation]...';


GO
ALTER TABLE [dbo].[Observation] DROP CONSTRAINT [UX_Observation];


GO
PRINT N'Dropping [dbo].[PK_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [PK_Organisation];


GO
PRINT N'Dropping [dbo].[PK_Organisation_Instrument]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] DROP CONSTRAINT [PK_Organisation_Instrument];


GO
PRINT N'Altering [dbo].[UserDownloads]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
ALTER TABLE [dbo].[UserDownloads] ALTER COLUMN [Description] VARCHAR (5000) NULL;


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Starting rebuilding table [dbo].[Organisation]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Organisation] (
    [ID]          UNIQUEIDENTIFIER CONSTRAINT [DF_Organisation_ID] DEFAULT (newid()) NOT NULL,
    [Code]        VARCHAR (50)     NOT NULL,
    [Name]        VARCHAR (150)    NOT NULL,
    [Description] VARCHAR (5000)   NULL,
    [Url]         VARCHAR (250)    NULL,
    [UserId]      UNIQUEIDENTIFIER NOT NULL,
    [AddedAt]     DATETIME         CONSTRAINT [DF_Organisation_AddedAt] DEFAULT GetDate() NULL,
    [UpdatedAt]   DATETIME         CONSTRAINT [DF_Organisation_UpdatedAt] DEFAULT GetDate() NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Organisation1] PRIMARY KEY CLUSTERED ([ID] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_UX_Organisation_Code1] UNIQUE NONCLUSTERED ([Code] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_UX_Organisation_Name1] UNIQUE NONCLUSTERED ([Name] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Organisation])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Organisation] ([ID], [Code], [Name], [Description], [Url], [UserId], [AddedAt], [UpdatedAt])
        SELECT   [ID],
                 [Code],
                 [Name],
                 [Description],
                 [Url],
                 [UserId],
                 [AddedAt],
                 [UpdatedAt]
        FROM     [dbo].[Organisation]
        ORDER BY [ID] ASC;
    END

DROP TABLE [dbo].[Organisation];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Organisation]', N'Organisation';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_Organisation1]', N'PK_Organisation', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UX_Organisation_Code1]', N'UX_Organisation_Code', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UX_Organisation_Name1]', N'UX_Organisation_Name', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[Organisation].[IX_Organisation_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_UserId]
    ON [dbo].[Organisation]([UserId] ASC);


GO
PRINT N'Starting rebuilding table [dbo].[Organisation_Instrument]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Organisation_Instrument] (
    [ID]                 UNIQUEIDENTIFIER CONSTRAINT [DF_Organisation_Instrument_ID] DEFAULT newid() NOT NULL,
    [OrganisationID]     UNIQUEIDENTIFIER NOT NULL,
    [InstrumentID]       UNIQUEIDENTIFIER NOT NULL,
    [OrganisationRoleID] UNIQUEIDENTIFIER NOT NULL,
    [StartDate]          DATE             NULL,
    [EndDate]            DATE             NULL,
    [UserId]             UNIQUEIDENTIFIER NOT NULL,
    [AddedAt]            DATETIME         CONSTRAINT [DF_Organisation_Instrument_AddedAt] DEFAULT GetDate() NULL,
    [UpdatedAt]          DATETIME         CONSTRAINT [DF_Organisation_Instrument_UpdatedAt] DEFAULT GetDate() NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Organisation_Instrument1] PRIMARY KEY CLUSTERED ([ID] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_UX_Organisation_Instrument1] UNIQUE NONCLUSTERED ([OrganisationID] ASC, [InstrumentID] ASC, [OrganisationRoleID] ASC, [StartDate] ASC, [EndDate] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Organisation_Instrument])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Organisation_Instrument] ([ID], [OrganisationID], [InstrumentID], [OrganisationRoleID], [StartDate], [EndDate], [UserId], [AddedAt], [UpdatedAt])
        SELECT   [ID],
                 [OrganisationID],
                 [InstrumentID],
                 [OrganisationRoleID],
                 [StartDate],
                 [EndDate],
                 [UserId],
                 [AddedAt],
                 [UpdatedAt]
        FROM     [dbo].[Organisation_Instrument]
        ORDER BY [ID] ASC;
    END

DROP TABLE [dbo].[Organisation_Instrument];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Organisation_Instrument]', N'Organisation_Instrument';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_Organisation_Instrument1]', N'PK_Organisation_Instrument', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_UX_Organisation_Instrument1]', N'UX_Organisation_Instrument', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[Organisation_Instrument].[IX_Organisation_Instrument_InstrumentID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_Instrument_InstrumentID]
    ON [dbo].[Organisation_Instrument]([InstrumentID] ASC);


GO
PRINT N'Creating [dbo].[Organisation_Instrument].[IX_Organisation_Instrument_OrganisationRoleID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_Instrument_OrganisationRoleID]
    ON [dbo].[Organisation_Instrument]([OrganisationRoleID] ASC);


GO
PRINT N'Creating [dbo].[Organisation_Instrument].[IX_Organisation_Instrument_OrganisationID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_Instrument_OrganisationID]
    ON [dbo].[Organisation_Instrument]([OrganisationID] ASC);


GO
PRINT N'Creating [dbo].[Organisation_Instrument].[IX_Organisation_Instrument_StartDate]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_Instrument_StartDate]
    ON [dbo].[Organisation_Instrument]([StartDate] ASC);


GO
PRINT N'Creating [dbo].[Organisation_Instrument].[IX_Organisation_Instrument_EndDate]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_Instrument_EndDate]
    ON [dbo].[Organisation_Instrument]([EndDate] ASC);


GO
PRINT N'Creating [dbo].[Organisation_Instrument].[IX_Organisation_Instrument_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_Instrument_UserId]
    ON [dbo].[Organisation_Instrument]([UserId] ASC);


GO
PRINT N'Creating [dbo].[DF_Observation_AddedAt]...';


GO
ALTER TABLE [dbo].[Observation]
    ADD CONSTRAINT [DF_Observation_AddedAt] DEFAULT GetDate() FOR [AddedAt];


GO
PRINT N'Creating [dbo].[DF_Observation_AddedDate]...';


GO
ALTER TABLE [dbo].[Observation]
    ADD CONSTRAINT [DF_Observation_AddedDate] DEFAULT getdate() FOR [AddedDate];


GO
PRINT N'Creating [dbo].[DF_Observation_ID]...';


GO
ALTER TABLE [dbo].[Observation]
    ADD CONSTRAINT [DF_Observation_ID] DEFAULT newid() FOR [ID];


GO
PRINT N'Creating [dbo].[DF_Observation_UpdatedAt]...';


GO
ALTER TABLE [dbo].[Observation]
    ADD CONSTRAINT [DF_Observation_UpdatedAt] DEFAULT GetDate() FOR [UpdatedAt];


GO
PRINT N'Creating [dbo].[FK_Organisation_Site_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation_Site] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_Site_Organisation] FOREIGN KEY ([OrganisationID]) REFERENCES [dbo].[Organisation] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Organisation_Station_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation_Station] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_Station_Organisation] FOREIGN KEY ([OrganisationID]) REFERENCES [dbo].[Organisation] ([ID]);


GO
PRINT N'Creating [dbo].[FK_ProjectSite_Organisation]...';


GO
ALTER TABLE [dbo].[ProjectSite] WITH NOCHECK
    ADD CONSTRAINT [FK_ProjectSite_Organisation] FOREIGN KEY ([OrganisationID]) REFERENCES [dbo].[Organisation] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Organisation_Instrument_Organisation]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_Instrument_Organisation] FOREIGN KEY ([OrganisationID]) REFERENCES [dbo].[Organisation] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Organisation_aspnet_Users]...';


GO
ALTER TABLE [dbo].[Organisation] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_Organisation_Instrument_Instrument]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_Instrument_Instrument] FOREIGN KEY ([InstrumentID]) REFERENCES [dbo].[Instrument] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Organisation_Instrument_OrganisationRole]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_Instrument_OrganisationRole] FOREIGN KEY ([OrganisationRoleID]) REFERENCES [dbo].[OrganisationRole] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Organisation_Instrument_aspnet_Users]...';


GO
ALTER TABLE [dbo].[Organisation_Instrument] WITH NOCHECK
    ADD CONSTRAINT [FK_Organisation_Instrument_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[TR_Organisation_Insert]...';


GO
CREATE TRIGGER [dbo].[TR_Organisation_Insert] ON [dbo].[Organisation]
FOR INSERT
AS
BEGIN
    SET NoCount ON
    Update 
        src 
    set 
        AddedAt = GETDATE(),
        UpdatedAt = NULL
    from
        Organisation src
        inner join inserted ins 
            on (ins.ID = src.ID)
END
GO
PRINT N'Creating [dbo].[TR_Organisation_Update]...';


GO
CREATE TRIGGER [dbo].[TR_Organisation_Update] ON [dbo].[Organisation]
FOR UPDATE
AS
BEGIN
    SET NoCount ON
    Update 
        src 
    set 
--> Changed 2.0.19 20161205 TimPN
--		AddedAt = del.AddedAt,
        AddedAt = Coalesce(del.AddedAt, ins.AddedAt, GetDate ()),
--< Changed 2.0.19 20161205 TimPN
        UpdatedAt = GETDATE()
    from
        Organisation src
        inner join inserted ins 
            on (ins.ID = src.ID)
        inner join deleted del
            on (del.ID = src.ID)
END
--> Changed 2.0.15 20161102 TimPN
--< Added 2.0.4 20160508 TimPN
GO
PRINT N'Creating [dbo].[TR_Organisation_Instrument_Insert]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TRIGGER [dbo].[TR_Organisation_Instrument_Insert] ON [dbo].[Organisation_Instrument]
FOR INSERT
AS
BEGIN
    SET NoCount ON
    Update
        src
    set
        AddedAt = GETDATE(),
        UpdatedAt = NULL
    from
        Organisation_Instrument src
        inner join inserted ins
            on (ins.ID = src.ID)
END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[TR_Organisation_Instrument_Update]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TRIGGER [dbo].[TR_Organisation_Instrument_Update] ON [dbo].[Organisation_Instrument]
FOR UPDATE
AS
BEGIN
    SET NoCount ON
    Update
        src
    set
--> Changed 2.0.19 20161205 TimPN
--		AddedAt = del.AddedAt,
        AddedAt = Coalesce(del.AddedAt, ins.AddedAt, GetDate ()),
--< Changed 2.0.19 20161205 TimPN
        UpdatedAt = GETDATE()
    from
        Organisation_Instrument src
        inner join inserted ins
            on (ins.ID = src.ID)
        inner join deleted del
            on (del.ID = src.ID)
END
--< Changed 2.0.15 20161102 TimPN
--< Added 2.0.5 20160530 TimPN
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[vInstrumentOrganisation]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vInstrumentOrganisation]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[vObservation]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vObservation]';


GO
PRINT N'Refreshing [dbo].[vOrganisationInstrument]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vOrganisationInstrument]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[vOrganisationSite]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vOrganisationSite]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[vOrganisationStation]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vOrganisationStation]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[vProjectSite]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vProjectSite]';


GO
PRINT N'Refreshing [dbo].[vSiteOrganisation]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vSiteOrganisation]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[vStationOrganisation]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vStationOrganisation]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering [dbo].[vObservationRoles]...';


GO
--> Changed 2.0.3 20160503 TimPN
--Renamed SensorProcedure to Sensor
--< Changed 2.0.3 20160503 TimPN
ALTER VIEW [dbo].[vObservationRoles]
AS
--> Changed 2.0.16 20161107 TimPN
----> Changed 2.0.3 20160421 TimPN
----SELECT     vo.ID, vo.SensorID, vo.PhenonmenonOfferingID, vo.PhenonmenonUOMID, vo.UserId, vo.RawValue, vo.DataValue, vo.ImportBatchID, vo.ValueDate, 
--SELECT     vo.ID, vo.SensorID, vo.PhenomenonOfferingID, vo.PhenomenonUOMID, vo.UserId, vo.RawValue, vo.DataValue, vo.ImportBatchID, vo.ValueDate, 
----> Changed 2.0.3 20160421 TimPN
--                      vo.spCode, vo.spDesc, vo.spName, vo.spURL, vo.DataSchemaID, vo.DataSourceID, vo.PhenomenonID, vo.StationID, vo.phName, vo.stName, vo.dsName, 
--                      vo.dschemaName, vo.offName, vo.offID, vo.psName, vo.psID, vo.orgName, vo.orgID, vo.uomUnit, vo.uomSymbol, vo.UserName,
--                      dr.DataSourceID AS Expr2, dr.DateStart, dr.DateEnd,
--                      ur.UserId AS Expr5, vo.Comment
--FROM         dbo.vObservation AS vo 
--INNER JOIN 
--(
-- SELECT dr.DataSourceID,
--        ur.UserId,
--        MIN(dr.DateStart) DateStart,
--        MAX(dr.DateEnd) DateEnd
-- FROM DataSourceRole dr
-- INNER JOIN    dbo.aspnet_Roles AS ar ON dr.RoleId = ar.RoleId INNER JOIN
--               dbo.aspnet_UsersInRoles AS ur ON ar.RoleId = ur.RoleId
-- GROUP By dr.DataSourceID,ur.UserId
--) dr
--ON vo.DataSourceID = dr.DataSourceID 
--AND vo.ValueDate >= dr.DateStart AND vo.ValueDate <= dr.DateEnd
--INNER JOIN aspnet_Users ur
-- ON dr.UserId = ur.UserId
    Select
--> Changed 20170213 TimPN
--        vObservation.*, DataSourceRoles.RoleUserId
      vObservation.*, DataSourceRoles.RoleUserId, DataSourceRoles.DateStart RoleStartDate, DataSourceRoles.DateEnd RoleEndDate
--< Changed 20170213 TimPN
    from
        vObservation
--> Changed 20170213 TimPN
--        inner join
        left join
--< Changed 20170213 TimPN
        (
            Select
                dsr.DataSourceID, aspnet_UsersInRoles.UserId RoleUserId, Min(dsr.DateStart) DateStart, Max(dsr.DateEnd) DateEnd
            from
                DataSourceRole dsr
            inner join aspnet_UsersInRoles
                on (dsr.RoleId = aspnet_UsersInRoles.RoleId)
            group by
                dsr.DataSourceID, aspnet_UsersInRoles.UserId
        ) DataSourceRoles
--> Changed 20170213 TimPN
        --on (vObservation.DataSourceID = DataSourceRoles.DataSourceID) and
        --   (vObservation.ValueDate >= DataSourceRoles.DateStart) and 
        --   (vObservation.ValueDate <= DataSourceRoles.DateEnd)
          on (vObservation.DataSourceID = DataSourceRoles.DataSourceID) 
        where
           ((DataSourceRoles.DateStart is null) or (vObservation.ValueDate >= DataSourceRoles.DateStart)) and 
           ((DataSourceRoles.DateEnd is null) or (vObservation.ValueDate <= DataSourceRoles.DateEnd))
--< Changed 20170213 TimPN
--< Changed 2.0.16 20161107 TimPN
GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Organisation_Site] WITH CHECK CHECK CONSTRAINT [FK_Organisation_Site_Organisation];

ALTER TABLE [dbo].[Organisation_Station] WITH CHECK CHECK CONSTRAINT [FK_Organisation_Station_Organisation];

ALTER TABLE [dbo].[ProjectSite] WITH CHECK CHECK CONSTRAINT [FK_ProjectSite_Organisation];

ALTER TABLE [dbo].[Organisation_Instrument] WITH CHECK CHECK CONSTRAINT [FK_Organisation_Instrument_Organisation];

ALTER TABLE [dbo].[Organisation] WITH CHECK CHECK CONSTRAINT [FK_Organisation_aspnet_Users];

ALTER TABLE [dbo].[Organisation_Instrument] WITH CHECK CHECK CONSTRAINT [FK_Organisation_Instrument_Instrument];

ALTER TABLE [dbo].[Organisation_Instrument] WITH CHECK CHECK CONSTRAINT [FK_Organisation_Instrument_OrganisationRole];

ALTER TABLE [dbo].[Organisation_Instrument] WITH CHECK CHECK CONSTRAINT [FK_Organisation_Instrument_aspnet_Users];


GO
PRINT N'Update complete.';


GO
