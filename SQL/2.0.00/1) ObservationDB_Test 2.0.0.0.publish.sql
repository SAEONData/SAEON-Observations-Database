/*
Deployment script for ObservationDB_Test

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ObservationDB_Test"
:setvar DefaultFilePrefix "ObservationDB_Test"
--:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL12.SAEON\MSSQL\DATA\"
--:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL12.SAEON\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[vDataQuery].[MS_DiagramPane1]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPane1', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vDataQuery';


GO
PRINT N'Dropping [dbo].[vDataQuery].[MS_DiagramPane2]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPane2', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vDataQuery';


GO
PRINT N'Dropping [dbo].[vDataQuery].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPaneCount', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vDataQuery';


GO
PRINT N'Dropping [dbo].[vModuleRoleModule].[MS_DiagramPane1]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPane1', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vModuleRoleModule';


GO
PRINT N'Dropping [dbo].[vModuleRoleModule].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPaneCount', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vModuleRoleModule';


GO
PRINT N'Dropping [dbo].[vObservation].[MS_DiagramPane1]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPane1', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vObservation';


GO
PRINT N'Dropping [dbo].[vObservation].[MS_DiagramPane2]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPane2', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vObservation';


GO
PRINT N'Dropping [dbo].[vObservation].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPaneCount', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vObservation';


GO
PRINT N'Dropping [dbo].[vUserInfo].[MS_DiagramPane1]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPane1', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vUserInfo';


GO
PRINT N'Dropping [dbo].[vUserInfo].[MS_DiagramPaneCount]...';


GO
EXECUTE sp_dropextendedproperty @name = N'MS_DiagramPaneCount', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'vUserInfo';


GO
PRINT N'Dropping [dbo].[Observation].[IX_Observation_BatchID]...';


GO
DROP INDEX [IX_Observation_BatchID]
    ON [dbo].[Observation];


GO
PRINT N'Dropping [dbo].[SensorProcedure].[IX_SensorProcedure_Name]...';


GO
DROP INDEX [IX_SensorProcedure_Name]
    ON [dbo].[SensorProcedure];


GO
PRINT N'Dropping [dbo].[FK_Observation_Observation]...';


GO
ALTER TABLE [dbo].[Observation] DROP CONSTRAINT [FK_Observation_Observation];


GO
PRINT N'Dropping [dbo].[IX_Module]...';


GO
ALTER TABLE [dbo].[Module] DROP CONSTRAINT [IX_Module];


GO
PRINT N'Dropping [dbo].[IX_Offering]...';


GO
ALTER TABLE [dbo].[Offering] DROP CONSTRAINT [IX_Offering];


GO
PRINT N'Dropping [dbo].[IX_Offering_Code]...';


GO
ALTER TABLE [dbo].[Offering] DROP CONSTRAINT [IX_Offering_Code];


GO
PRINT N'Dropping [dbo].[IX_Organisation_Code]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [IX_Organisation_Code];


GO
PRINT N'Dropping [dbo].[IX_Organisation_Name]...';


GO
ALTER TABLE [dbo].[Organisation] DROP CONSTRAINT [IX_Organisation_Name];


GO
PRINT N'Dropping [dbo].[IX_Phenomenon_Code]...';


GO
ALTER TABLE [dbo].[Phenomenon] DROP CONSTRAINT [IX_Phenomenon_Code];


GO
PRINT N'Dropping [dbo].[IX_Phenomenon_Name]...';


GO
ALTER TABLE [dbo].[Phenomenon] DROP CONSTRAINT [IX_Phenomenon_Name];


GO
PRINT N'Dropping [dbo].[IX_PhenomenonUOM]...';


GO
ALTER TABLE [dbo].[PhenomenonUOM] DROP CONSTRAINT [IX_PhenomenonUOM];


GO
PRINT N'Dropping [dbo].[IX_ProjectSite_Code]...';


GO
ALTER TABLE [dbo].[ProjectSite] DROP CONSTRAINT [IX_ProjectSite_Code];


GO
PRINT N'Dropping [dbo].[IX_ProjectSite_Name]...';


GO
ALTER TABLE [dbo].[ProjectSite] DROP CONSTRAINT [IX_ProjectSite_Name];


GO
PRINT N'Dropping [dbo].[IX_SensorProcedure_Code]...';


GO
ALTER TABLE [dbo].[SensorProcedure] DROP CONSTRAINT [IX_SensorProcedure_Code];


GO
PRINT N'Dropping [dbo].[IX_Station_Code]...';


GO
ALTER TABLE [dbo].[Station] DROP CONSTRAINT [IX_Station_Code];


GO
PRINT N'Dropping [dbo].[IX_Station_Name]...';


GO
ALTER TABLE [dbo].[Station] DROP CONSTRAINT [IX_Station_Name];


GO
PRINT N'Dropping [dbo].[IX_Status_Code]...';


GO
ALTER TABLE [dbo].[Status] DROP CONSTRAINT [IX_Status_Code];


GO
PRINT N'Dropping [dbo].[IX_Status_Name]...';


GO
ALTER TABLE [dbo].[Status] DROP CONSTRAINT [IX_Status_Name];


GO
PRINT N'Dropping [dbo].[IX_UnitOfMeasure_Code]...';


GO
ALTER TABLE [dbo].[UnitOfMeasure] DROP CONSTRAINT [IX_UnitOfMeasure_Code];


GO
PRINT N'Dropping [dbo].[IX_UnitOfMeasure_Unit]...';


GO
ALTER TABLE [dbo].[UnitOfMeasure] DROP CONSTRAINT [IX_UnitOfMeasure_Unit];


GO
PRINT N'Altering [dbo].[DataSourceRole]...';


GO
ALTER TABLE [dbo].[DataSourceRole]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[DataSourceRole].[IX_DataSourceRole_DataSourceID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceRole_DataSourceID]
    ON [dbo].[DataSourceRole]([DataSourceID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceRole].[IX_DataSourceRole_RoleId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceRole_RoleId]
    ON [dbo].[DataSourceRole]([RoleId] ASC);


GO
PRINT N'Creating [dbo].[DataSourceRole].[IX_DataSourceRole_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceRole_UserId]
    ON [dbo].[DataSourceRole]([UserId] ASC);


GO
PRINT N'Altering [dbo].[DataSourceTransformation]...';


GO
ALTER TABLE [dbo].[DataSourceTransformation]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_DataSourceID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_DataSourceID]
    ON [dbo].[DataSourceTransformation]([DataSourceID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_NewPhenomenonOfferingID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_NewPhenomenonOfferingID]
    ON [dbo].[DataSourceTransformation]([NewPhenomenonOfferingID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_NewPhenomenonUOMID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_NewPhenomenonUOMID]
    ON [dbo].[DataSourceTransformation]([NewPhenomenonUOMID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_PhenomenonID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_PhenomenonID]
    ON [dbo].[DataSourceTransformation]([PhenomenonID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_PhenomenonOfferingID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_PhenomenonOfferingID]
    ON [dbo].[DataSourceTransformation]([PhenomenonOfferingID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_PhenomenonUOMID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_PhenomenonUOMID]
    ON [dbo].[DataSourceTransformation]([PhenomenonUOMID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_TransformationTypeID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_TransformationTypeID]
    ON [dbo].[DataSourceTransformation]([TransformationTypeID] ASC);


GO
PRINT N'Creating [dbo].[DataSourceTransformation].[IX_DataSourceTransformation_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceTransformation_UserId]
    ON [dbo].[DataSourceTransformation]([UserId] ASC);


GO
PRINT N'Altering [dbo].[DataSourceType]...';


GO
ALTER TABLE [dbo].[DataSourceType]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[UX_DataSourceType_Code]...';


GO
ALTER TABLE [dbo].[DataSourceType]
    ADD CONSTRAINT [UX_DataSourceType_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[DataSourceType].[IX_DataSourceType_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSourceType_UserId]
    ON [dbo].[DataSourceType]([UserId] ASC);


GO
PRINT N'Altering [dbo].[PhenomenonOffering]...';


GO
ALTER TABLE [dbo].[PhenomenonOffering]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[UX_PhenomenonOffering]...';


GO
ALTER TABLE [dbo].[PhenomenonOffering]
    ADD CONSTRAINT [UX_PhenomenonOffering] UNIQUE NONCLUSTERED ([PhenomenonID] ASC, [OfferingID] ASC);


GO
PRINT N'Creating [dbo].[PhenomenonOffering].[IX_PhenomenonOffering_OfferingID]...';


GO
CREATE NONCLUSTERED INDEX [IX_PhenomenonOffering_OfferingID]
    ON [dbo].[PhenomenonOffering]([OfferingID] ASC);


GO
PRINT N'Creating [dbo].[PhenomenonOffering].[IX_PhenomenonOffering_PhenomenonID]...';


GO
CREATE NONCLUSTERED INDEX [IX_PhenomenonOffering_PhenomenonID]
    ON [dbo].[PhenomenonOffering]([PhenomenonID] ASC);


GO
PRINT N'Creating [dbo].[PhenomenonOffering].[IX_PhenomenonOffering_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_PhenomenonOffering_UserId]
    ON [dbo].[PhenomenonOffering]([UserId] ASC);


GO
PRINT N'Altering [dbo].[PhenomenonUOM]...';


GO
ALTER TABLE [dbo].[PhenomenonUOM]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[UX_PhenomenonUOM]...';


GO
ALTER TABLE [dbo].[PhenomenonUOM]
    ADD CONSTRAINT [UX_PhenomenonUOM] UNIQUE NONCLUSTERED ([PhenomenonID] ASC, [UnitOfMeasureID] ASC);


GO
PRINT N'Creating [dbo].[PhenomenonUOM].[IX_PhenomenonUOM_PhenomenonID]...';


GO
CREATE NONCLUSTERED INDEX [IX_PhenomenonUOM_PhenomenonID]
    ON [dbo].[PhenomenonUOM]([PhenomenonID] ASC);


GO
PRINT N'Creating [dbo].[PhenomenonUOM].[IX_PhenomenonUOM_UnitOfMeasureID]...';


GO
CREATE NONCLUSTERED INDEX [IX_PhenomenonUOM_UnitOfMeasureID]
    ON [dbo].[PhenomenonUOM]([UnitOfMeasureID] ASC);


GO
PRINT N'Creating [dbo].[PhenomenonUOM].[IX_PhenomenonUOM_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_PhenomenonUOM_UserId]
    ON [dbo].[PhenomenonUOM]([UserId] ASC);


GO
PRINT N'Altering [dbo].[Status]...';


GO
ALTER TABLE [dbo].[Status]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[UX_Status_Code]...';


GO
ALTER TABLE [dbo].[Status]
    ADD CONSTRAINT [UX_Status_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_Status_Name]...';


GO
ALTER TABLE [dbo].[Status]
    ADD CONSTRAINT [UX_Status_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[Status].[IX_Status_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Status_UserId]
    ON [dbo].[Status]([UserId] ASC);


GO
PRINT N'Altering [dbo].[TransformationType]...';


GO
ALTER TABLE [dbo].[TransformationType]
    ADD [UserId] UNIQUEIDENTIFIER NULL;


GO
PRINT N'Creating [dbo].[UX_TransformationType_Code]...';


GO
ALTER TABLE [dbo].[TransformationType]
    ADD CONSTRAINT [UX_TransformationType_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_TransformationType_Name]...';


GO
ALTER TABLE [dbo].[TransformationType]
    ADD CONSTRAINT [UX_TransformationType_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[TransformationType].[IX_TransformationType_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_TransformationType_UserId]
    ON [dbo].[TransformationType]([UserId] ASC);


GO
PRINT N'Creating [dbo].[Progress]...';


GO
CREATE TABLE [dbo].[Progress] (
    [ImportBatchID]         INT              NULL,
    [StartDate]             DATETIME         NULL,
    [EndDate]               DATETIME         NULL,
    [DateUploaded]          DATETIME         NULL,
    [Observations]          BIGINT           NULL,
    [UserId]                UNIQUEIDENTIFIER NULL,
    [SensorProcedureID]     UNIQUEIDENTIFIER NULL,
    [PhenonmenonOfferingID] UNIQUEIDENTIFIER NULL
);


GO
PRINT N'Creating [dbo].[Progress].[IX_Progress_ImportBatchID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Progress_ImportBatchID]
    ON [dbo].[Progress]([ImportBatchID] ASC);


GO
PRINT N'Creating [dbo].[Progress].[IX_Progress_SensorProcedureID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Progress_SensorProcedureID]
    ON [dbo].[Progress]([SensorProcedureID] ASC);


GO
PRINT N'Creating [dbo].[Progress].[IX_Progress_PhenomenonOfferingID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Progress_PhenomenonOfferingID]
    ON [dbo].[Progress]([PhenonmenonOfferingID] ASC);


GO
PRINT N'Creating [dbo].[Progress].[IX_Progress_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Progress_UserId]
    ON [dbo].[Progress]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_DataSchema_Code]...';


GO
ALTER TABLE [dbo].[DataSchema]
    ADD CONSTRAINT [UX_DataSchema_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_DataSchema_Name]...';


GO
ALTER TABLE [dbo].[DataSchema]
    ADD CONSTRAINT [UX_DataSchema_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[DataSchema].[IX_DataSchema_DataSourceTypeID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSchema_DataSourceTypeID]
    ON [dbo].[DataSchema]([DataSourceTypeID] ASC);


GO
PRINT N'Creating [dbo].[DataSchema].[IX_DataSchema_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSchema_UserId]
    ON [dbo].[DataSchema]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_DataSource_Code]...';


GO
ALTER TABLE [dbo].[DataSource]
    ADD CONSTRAINT [UX_DataSource_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_DataSource_Name]...';


GO
ALTER TABLE [dbo].[DataSource]
    ADD CONSTRAINT [UX_DataSource_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[DataSource].[IX_DataSource_DataSchemaID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSource_DataSchemaID]
    ON [dbo].[DataSource]([DataSchemaID] ASC);


GO
PRINT N'Creating [dbo].[DataSource].[IX_DataSource_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataSource_UserId]
    ON [dbo].[DataSource]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_Offering_Code]...';


GO
ALTER TABLE [dbo].[Offering]
    ADD CONSTRAINT [UX_Offering_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_Offering_Name]...';


GO
ALTER TABLE [dbo].[Offering]
    ADD CONSTRAINT [UX_Offering_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[Offering].[IX_Offering_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Offering_UserId]
    ON [dbo].[Offering]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_Organisation_Code]...';


GO
ALTER TABLE [dbo].[Organisation]
    ADD CONSTRAINT [UX_Organisation_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_Organisation_Name]...';


GO
ALTER TABLE [dbo].[Organisation]
    ADD CONSTRAINT [UX_Organisation_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[Organisation].[IX_Organisation_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Organisation_UserId]
    ON [dbo].[Organisation]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_Phenomenon_Code]...';


GO
ALTER TABLE [dbo].[Phenomenon]
    ADD CONSTRAINT [UX_Phenomenon_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_Phenomenon_Name]...';


GO
ALTER TABLE [dbo].[Phenomenon]
    ADD CONSTRAINT [UX_Phenomenon_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[Phenomenon].[IX_Phenomenon_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Phenomenon_UserId]
    ON [dbo].[Phenomenon]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_ProjectSite_Code]...';


GO
ALTER TABLE [dbo].[ProjectSite]
    ADD CONSTRAINT [UX_ProjectSite_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_ProjectSite_Name]...';


GO
ALTER TABLE [dbo].[ProjectSite]
    ADD CONSTRAINT [UX_ProjectSite_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[ProjectSite].[IX_ProjectSite_OrganisationID]...';


GO
CREATE NONCLUSTERED INDEX [IX_ProjectSite_OrganisationID]
    ON [dbo].[ProjectSite]([OrganisationID] ASC);


GO
PRINT N'Creating [dbo].[ProjectSite].[IX_ProjectSite_UserID]...';


GO
CREATE NONCLUSTERED INDEX [IX_ProjectSite_UserID]
    ON [dbo].[ProjectSite]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_SensorProcedure_Code]...';


GO
ALTER TABLE [dbo].[SensorProcedure]
    ADD CONSTRAINT [UX_SensorProcedure_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_SensorProcedure_Name]...';


GO
ALTER TABLE [dbo].[SensorProcedure]
    ADD CONSTRAINT [UX_SensorProcedure_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[SensorProcedure].[IX_SensorProcedure_DataSchemaID]...';


GO
CREATE NONCLUSTERED INDEX [IX_SensorProcedure_DataSchemaID]
    ON [dbo].[SensorProcedure]([DataSchemaID] ASC);


GO
PRINT N'Creating [dbo].[SensorProcedure].[IX_SensorProcedure_DataSourceID]...';


GO
CREATE NONCLUSTERED INDEX [IX_SensorProcedure_DataSourceID]
    ON [dbo].[SensorProcedure]([DataSourceID] ASC);


GO
PRINT N'Creating [dbo].[SensorProcedure].[IX_SensorProcedure_PhenomenonID]...';


GO
CREATE NONCLUSTERED INDEX [IX_SensorProcedure_PhenomenonID]
    ON [dbo].[SensorProcedure]([PhenomenonID] ASC);


GO
PRINT N'Creating [dbo].[SensorProcedure].[IX_SensorProcedure_StationID]...';


GO
CREATE NONCLUSTERED INDEX [IX_SensorProcedure_StationID]
    ON [dbo].[SensorProcedure]([StationID] ASC);


GO
PRINT N'Creating [dbo].[SensorProcedure].[IX_SensorProcedure_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_SensorProcedure_UserId]
    ON [dbo].[SensorProcedure]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_Station_Code]...';


GO
ALTER TABLE [dbo].[Station]
    ADD CONSTRAINT [UX_Station_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_Station_Name]...';


GO
ALTER TABLE [dbo].[Station]
    ADD CONSTRAINT [UX_Station_Name] UNIQUE NONCLUSTERED ([Name] ASC);


GO
PRINT N'Creating [dbo].[Station].[IX_Station_ProjectSiteID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Station_ProjectSiteID]
    ON [dbo].[Station]([ProjectSiteID] ASC);


GO
PRINT N'Creating [dbo].[Station].[IX_Station_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Station_UserId]
    ON [dbo].[Station]([UserId] ASC);


GO
PRINT N'Creating [dbo].[UX_UnitOfMeasure_Code]...';


GO
ALTER TABLE [dbo].[UnitOfMeasure]
    ADD CONSTRAINT [UX_UnitOfMeasure_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[UX_UnitOfMeasure_Unit]...';


GO
ALTER TABLE [dbo].[UnitOfMeasure]
    ADD CONSTRAINT [UX_UnitOfMeasure_Unit] UNIQUE NONCLUSTERED ([Unit] ASC);


GO
PRINT N'Creating [dbo].[UnitOfMeasure].[IX_UnitOfMeasure_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_UnitOfMeasure_UserId]
    ON [dbo].[UnitOfMeasure]([UserId] ASC);


GO
PRINT N'Creating [dbo].[DataLog].[IX_DataLog_DataSourceTransformationID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataLog_DataSourceTransformationID]
    ON [dbo].[DataLog]([DataSourceTransformationID] ASC);


GO
PRINT N'Creating [dbo].[DataLog].[IX_DataLog_PhenomenonOfferingID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataLog_PhenomenonOfferingID]
    ON [dbo].[DataLog]([PhenomenonOfferingID] ASC);


GO
PRINT N'Creating [dbo].[DataLog].[IX_DataLog_PhenomenonUOMID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataLog_PhenomenonUOMID]
    ON [dbo].[DataLog]([PhenonmenonUOMID] ASC);


GO
PRINT N'Creating [dbo].[DataLog].[IX_DataLog_SensorProcedureID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataLog_SensorProcedureID]
    ON [dbo].[DataLog]([SensorProcedureID] ASC);


GO
PRINT N'Creating [dbo].[DataLog].[IX_DataLog_StatusID]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataLog_StatusID]
    ON [dbo].[DataLog]([StatusID] ASC);


GO
PRINT N'Creating [dbo].[DataLog].[IX_DataLog_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_DataLog_UserId]
    ON [dbo].[DataLog]([UserId] ASC);


GO
PRINT N'Creating [dbo].[ImportBatch].[IX_ImportBatch_DataSourceID]...';


GO
CREATE NONCLUSTERED INDEX [IX_ImportBatch_DataSourceID]
    ON [dbo].[ImportBatch]([DataSourceID] ASC);


GO
PRINT N'Creating [dbo].[ImportBatch].[IX_ImportBatch_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_ImportBatch_UserId]
    ON [dbo].[ImportBatch]([UserId] ASC);


GO
PRINT N'Creating [dbo].[Module].[IX_Module_ModuleID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Module_ModuleID]
    ON [dbo].[Module]([ModuleID] ASC);


GO
PRINT N'Creating [dbo].[Observation].[IX_Observation_ImportBatchID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Observation_ImportBatchID]
    ON [dbo].[Observation]([ImportBatchID] ASC);


GO
PRINT N'Creating [dbo].[Observation].[IX_Observation_PhenomenonOfferingID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Observation_PhenomenonOfferingID]
    ON [dbo].[Observation]([PhenonmenonOfferingID] ASC);


GO
PRINT N'Creating [dbo].[Observation].[IX_Observation_PhenomenonUOMID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Observation_PhenomenonUOMID]
    ON [dbo].[Observation]([PhenonmenonUOMID] ASC);


GO
PRINT N'Creating [dbo].[Observation].[IX_Observation_SensorProcedureID]...';


GO
CREATE NONCLUSTERED INDEX [IX_Observation_SensorProcedureID]
    ON [dbo].[Observation]([SensorProcedureID] ASC);


GO
PRINT N'Creating [dbo].[Observation].[IX_Observation_UserId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Observation_UserId]
    ON [dbo].[Observation]([UserId] ASC);


GO
PRINT N'Creating [dbo].[RoleModule].[IX_RoleModule_ModuleID]...';


GO
CREATE NONCLUSTERED INDEX [IX_RoleModule_ModuleID]
    ON [dbo].[RoleModule]([ModuleID] ASC);


GO
PRINT N'Creating [dbo].[RoleModule].[IX_RoleModule_RoleId]...';


GO
CREATE NONCLUSTERED INDEX [IX_RoleModule_RoleId]
    ON [dbo].[RoleModule]([RoleId] ASC);


GO
PRINT N'Creating [dbo].[DF_DataSourceTransformation_Rank]...';


GO
ALTER TABLE [dbo].[DataSourceTransformation]
    ADD CONSTRAINT [DF_DataSourceTransformation_Rank] DEFAULT ((0)) FOR [Rank];


GO
PRINT N'Creating [dbo].[DF_ImportBatch_Guid]...';


GO
ALTER TABLE [dbo].[ImportBatch]
    ADD CONSTRAINT [DF_ImportBatch_Guid] DEFAULT (newid()) FOR [Guid];


GO
PRINT N'Creating [dbo].[FK_Progress_ImportBatch]...';


GO
ALTER TABLE [dbo].[Progress] WITH NOCHECK
    ADD CONSTRAINT [FK_Progress_ImportBatch] FOREIGN KEY ([ImportBatchID]) REFERENCES [dbo].[ImportBatch] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Progress_SensorProcedure]...';


GO
ALTER TABLE [dbo].[Progress] WITH NOCHECK
    ADD CONSTRAINT [FK_Progress_SensorProcedure] FOREIGN KEY ([SensorProcedureID]) REFERENCES [dbo].[SensorProcedure] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Progress_PhenomenonOffering]...';


GO
ALTER TABLE [dbo].[Progress] WITH NOCHECK
    ADD CONSTRAINT [FK_Progress_PhenomenonOffering] FOREIGN KEY ([PhenonmenonOfferingID]) REFERENCES [dbo].[PhenomenonOffering] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Progress_aspnet_Users]...';


GO
ALTER TABLE [dbo].[Progress] WITH NOCHECK
    ADD CONSTRAINT [FK_Progress_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_DataSourceRole_aspnet_Users]...';


GO
ALTER TABLE [dbo].[DataSourceRole] WITH NOCHECK
    ADD CONSTRAINT [FK_DataSourceRole_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_DataSourceTransformation_aspnet_Users]...';


GO
ALTER TABLE [dbo].[DataSourceTransformation] WITH NOCHECK
    ADD CONSTRAINT [FK_DataSourceTransformation_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_DataSourceType_aspnet_Users]...';


GO
ALTER TABLE [dbo].[DataSourceType] WITH NOCHECK
    ADD CONSTRAINT [FK_DataSourceType_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_Observation_ImportBatch]...';


GO
ALTER TABLE [dbo].[Observation] WITH NOCHECK
    ADD CONSTRAINT [FK_Observation_ImportBatch] FOREIGN KEY ([ImportBatchID]) REFERENCES [dbo].[ImportBatch] ([ID]);


GO
PRINT N'Creating [dbo].[FK_PhenomenonOffering_aspnet_Users]...';


GO
ALTER TABLE [dbo].[PhenomenonOffering] WITH NOCHECK
    ADD CONSTRAINT [FK_PhenomenonOffering_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_PhenomenonUOM_aspnet_Users]...';


GO
ALTER TABLE [dbo].[PhenomenonUOM] WITH NOCHECK
    ADD CONSTRAINT [FK_PhenomenonUOM_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_Status_aspnet_Users]...';


GO
ALTER TABLE [dbo].[Status] WITH NOCHECK
    ADD CONSTRAINT [FK_Status_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Creating [dbo].[FK_TransformationType_aspnet_Users]...';


GO
ALTER TABLE [dbo].[TransformationType] WITH NOCHECK
    ADD CONSTRAINT [FK_TransformationType_aspnet_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[aspnet_Users] ([UserId]);


GO
PRINT N'Refreshing [dbo].[vDataLog]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vDataLog]';


GO
PRINT N'Refreshing [dbo].[vDataSourceTransformation]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vDataSourceTransformation]';


GO
PRINT N'Refreshing [dbo].[vDataSchema]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vDataSchema]';


GO
PRINT N'Refreshing [dbo].[vDataQuery]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vDataQuery]';


GO
PRINT N'Refreshing [dbo].[vObservation]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vObservation]';


GO
PRINT N'Altering [dbo].[vStation]...';


GO
ALTER VIEW [dbo].[vStation]
AS

SELECT s.*,p.Code + ' - ' + p.Name as ProjectSiteName FROM Station s
 INNER JOIN ProjectSite p
    on s.ProjectSiteID = p.ID
GO
PRINT N'Creating [dbo].[progress_Progress_Resolved]...';


GO
CREATE VIEW dbo.progress_Progress_Resolved
AS
SELECT     dbo.ImportBatch.ImportDate, dbo.ImportBatch.FileName, dbo.Progress.StartDate, dbo.Progress.EndDate, dbo.Progress.Observations, dbo.Progress.DateUploaded, 
                      dbo.aspnet_Users.UserName, dbo.SensorProcedure.Name AS SensorProcedure, dbo.SensorProcedure.StationID, dbo.Station.Name AS Station
FROM         dbo.SensorProcedure FULL OUTER JOIN
                      dbo.Station ON dbo.SensorProcedure.StationID = dbo.Station.ID FULL OUTER JOIN
                      dbo.Progress LEFT OUTER JOIN
                      dbo.aspnet_Users ON dbo.Progress.UserId = dbo.aspnet_Users.UserId LEFT OUTER JOIN
                      dbo.ImportBatch ON dbo.Progress.ImportBatchID = dbo.ImportBatch.ID ON dbo.SensorProcedure.ID = dbo.Progress.SensorProcedureID
GO
PRINT N'Refreshing [dbo].[vObservationRoles]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vObservationRoles]';


GO
PRINT N'Altering [dbo].[aspnet_Membership_GetUserByEmail]...';


GO
SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER OFF;


GO
ALTER PROCEDURE dbo.aspnet_Membership_GetUserByEmail
    @ApplicationName  nvarchar(256),
    @Email            nvarchar(256)
AS
BEGIN
    IF( @Email IS NULL )
        SELECT  u.UserName
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m
        WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
                u.ApplicationId = a.ApplicationId    AND
                u.UserId = m.UserId AND
                m.ApplicationId = a.ApplicationId AND
                m.LoweredEmail IS NULL
    ELSE
        SELECT  u.UserName
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m
        WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
                u.ApplicationId = a.ApplicationId    AND
                u.UserId = m.UserId AND
                m.ApplicationId = a.ApplicationId AND
                LOWER(@Email) = m.LoweredEmail

    IF (@@rowcount = 0)
        RETURN(1)
    RETURN(0)
END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering [dbo].[aspnet_Setup_RestorePermissions]...';


GO
SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].aspnet_Setup_RestorePermissions
    @name   sysname
AS
BEGIN
    DECLARE @object sysname
    DECLARE @protectType char(10)
    DECLARE @action varchar(60)
    DECLARE @grantee sysname
    DECLARE @cmd nvarchar(500)
    IF(OBJECT_ID('tempdb.#aspnet_Permissions') IS NULL)
       BEGIN
          CREATE TABLE #aspnet_Permissions
           (
             Owner     sysname,
         Object    sysname,  
         Grantee   sysname,  
         Grantor   sysname,  
         ProtectType char(10),  
         [Action]    varchar(60),  
         [Column]    sysname
          )
       END
    DECLARE c1 cursor FORWARD_ONLY FOR
        SELECT Object, ProtectType, [Action], Grantee FROM #aspnet_Permissions where Object = @name

    OPEN c1

    FETCH c1 INTO @object, @protectType, @action, @grantee
    WHILE (@@fetch_status = 0)
    BEGIN
        SET @cmd = @protectType + ' ' + @action + ' on ' + @object + ' TO [' + @grantee + ']'
        EXEC (@cmd)
        FETCH c1 INTO @object, @protectType, @action, @grantee
    END

    CLOSE c1
    DEALLOCATE c1
END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[progress_Status_Raw]...';


GO
-- =============================================
-- Author:		Wim Hugo
-- Create date: 20-06-2014
-- Description:	Create Progress Table - Raw Data
-- =============================================
CREATE PROCEDURE progress_Status_Raw 
    -- Add the parameters for the stored procedure here

AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON;
    
    DROP Table dbo.Progress
    
    CREATE TABLE [dbo].Progress(
    [ImportBatchID] [int],
    [StartDate] [datetime],
    [EndDate] [datetime],
    [DateUploaded] [datetime],
    [Observations] [bigint],
    [UserId] [uniqueidentifier],
    [SensorProcedureID] [uniqueidentifier],
    [PhenonmenonOfferingID] [uniqueidentifier]
    )

    -- Insert statements for procedure here
    INSERT INTO [dbo].[Progress]
    (
    [ImportBatchID],
    [StartDate],
    [EndDate],
    [DateUploaded],
    [Observations],
    [UserId],
    [SensorProcedureID],
    [PhenonmenonOfferingID]
    )
   
    SELECT     
        ImportBatchID, 
        MIN(ValueDate) AS StartDate, 
        MAX(ValueDate) AS EndDate, 
        MIN(AddedDate) AS DateUploaded, 
        COUNT(ID) AS Observations, 
        UserId, 
        SensorProcedureID, 
        PhenonmenonOfferingID
FROM    dbo.Observation
GROUP BY PhenonmenonOfferingID, PhenonmenonUOMID, ImportBatchID, UserId, SensorProcedureID
END
GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Progress] WITH CHECK CHECK CONSTRAINT [FK_Progress_ImportBatch];

ALTER TABLE [dbo].[Progress] WITH CHECK CHECK CONSTRAINT [FK_Progress_SensorProcedure];

ALTER TABLE [dbo].[Progress] WITH CHECK CHECK CONSTRAINT [FK_Progress_PhenomenonOffering];

ALTER TABLE [dbo].[Progress] WITH CHECK CHECK CONSTRAINT [FK_Progress_aspnet_Users];

ALTER TABLE [dbo].[DataSourceRole] WITH CHECK CHECK CONSTRAINT [FK_DataSourceRole_aspnet_Users];

ALTER TABLE [dbo].[DataSourceTransformation] WITH CHECK CHECK CONSTRAINT [FK_DataSourceTransformation_aspnet_Users];

ALTER TABLE [dbo].[DataSourceType] WITH CHECK CHECK CONSTRAINT [FK_DataSourceType_aspnet_Users];

ALTER TABLE [dbo].[Observation] WITH CHECK CHECK CONSTRAINT [FK_Observation_ImportBatch];

ALTER TABLE [dbo].[PhenomenonOffering] WITH CHECK CHECK CONSTRAINT [FK_PhenomenonOffering_aspnet_Users];

ALTER TABLE [dbo].[PhenomenonUOM] WITH CHECK CHECK CONSTRAINT [FK_PhenomenonUOM_aspnet_Users];

ALTER TABLE [dbo].[Status] WITH CHECK CHECK CONSTRAINT [FK_Status_aspnet_Users];

ALTER TABLE [dbo].[TransformationType] WITH CHECK CHECK CONSTRAINT [FK_TransformationType_aspnet_Users];


GO
PRINT N'Update complete.';


GO
