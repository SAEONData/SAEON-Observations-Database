@using SAEON.Observations.QuerySite.Models
@model QueryModel
@(Html.EJ().TreeView("treeViewFeatures")
    .TreeViewFields(field => field.Datasource(Model.Features)
        .Id("Key")
        .ParentId("ParentKey")
        .Text("Text")
        .HasChild("HasChildren")
        .IsChecked("IsChecked")
        .Expanded("IsExpanded")
        .Selected("IsSelected")
    )
    .ClientSideEvents(events => events
        .NodeCheck("onUpdateSelectedFeatures")
        .NodeUncheck("onUpdateSelectedFeatures")
        .Ready("onTreeViewFeaturesReady"))
    .ShowCheckbox(true)
)
<script type="text/javascript">
    function onTreeViewFeaturesReady() {
        EnableButtons();
        var wp = $("#waiting").data("ejWaitingPopup");
        wp.hide();
    }
    function onUpdateSelectedFeatures() {
        treeObj = $("#treeViewFeatures").data('ejTreeView');
        var checkedNodes = treeObj.getCheckedNodes();
        var selectedFeatures = []
        for (i = 0; i < checkedNodes.length; i++) {
            var checkedNode = checkedNodes[i];
            var nodeData = treeObj.getNode(checkedNode);
            selectedFeatures.push(nodeData.id);
        }
        $.post("/Query/UpdateSelectedFeatures", { Features: selectedFeatures })
            .done(function (data) {
                $('#PartialSelectedFeatures').html(data);
                EnableButtons();
            })
            .fail(function () { alert("Oops"); });
    }
</script>
