@using SAEON.Observations.QuerySite.Models
@model QueryModel
@(
Html.EJ().TreeView("treeViewLocations")
    .TreeViewFields(field => field
        .Datasource(Model.SelectedLocations)
        .Id("Key")
        .ParentId("ParentKey")
        .Text("Text")
        .HasChild("HasChildren")
        .IsChecked("IsChecked")
        .Expanded("IsExpanded")
        .Selected("IsSelected")
    )
    .ClientSideEvents(events => events
        .NodeCheck("onUpdateSelectedLocations")
        .NodeUncheck("onUpdateSelectedLocations"))
    .ShowCheckbox(true)
)
<script type="text/javascript">
    function onUpdateSelectedLocations() {
        treeObj = $("#treeViewLocations").data('ejTreeView');
        var checkedNodes = treeObj.getCheckedNodes();
        var selectedLocations = []
        for (i = 0; i < checkedNodes.length; i++) {
            var checkedNode = checkedNodes[i];
            var nodeData = treeObj.getNode(checkedNode);
            selectedLocations.push(nodeData.id);
        }
        ajaxUpdateSelectedLocations(selectedLocations);
    }
    function ajaxUpdateSelectedLocations(selectedLocations) {
        $.ajax({
            url: "/Query/UpdateSelectedLocations",
            data: JSON.stringify({ Locations: selectedLocations }),
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            success: function (data) {
                //alert(data)
                $('#PartialSelectedLocations').html(data);
            },
            error: function () {
                alert("Oops");
            }
        });
    }
</script>
