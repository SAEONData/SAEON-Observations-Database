@using SAEON.Observations.QuerySite.Models
@model QueryModel
@{
    Html.EJ()
        .Button("btnLoadQuery")
        .Text("Load Query")
        .ShowRoundedCorner(true)
        .Type(ButtonType.Button)
        .Size(ButtonSize.Medium)
        .ContentType(ContentType.TextAndImage)
        .PrefixIcon("e-icon e-reload")
        .ClientSideEvents(e => e.Click("onLoadQueryClick"))
        .Render();
    Html.EJ()
        .Dialog("dialogLoadQuery")
        .Title("Load query")
        .ShowOnInit(false)
        .Width("auto")
        .ContentTemplate(
        @<text>
            <div class="row">
                <div class="col-md-12">
                    @(Html.EJ()
                        .Autocomplete("editLoadName")
                        .Datasource(ds => ds.URL("/Query/GetUserQueries").Adaptor(AdaptorType.WebApiAdaptor))
                        .AutocompleteFields(f => f.Text("Name").Key("Id"))
                        .WatermarkText("Name")
                        .Width("300px")
                        .ShowPopupButton(true)
                        .ClientSideEvents(ev => ev.Change("onLoadNameChange"))
                    )
                </div>
            </div>
            <div class="row ErrorRow">
                <div class="col-md-12" id="LoadError">
                </div>
            </div>
            <div class="row ButtonRow">
                <div class="col-md-12">
                    @(Html.EJ()
                        .Button("btnLoad")
                        .Text("Load")
                        .ShowRoundedCorner(true)
                        .Type(ButtonType.Button)
                        .Size(ButtonSize.Medium)
                        .ContentType(ContentType.TextAndImage)
                        .PrefixIcon("e-icon e-save")
                        .Enabled(false)
                        .ClientSideEvents(e => e.Click("onLoadClick"))
                    )
                </div>
            </div>
        </text>)
        .Render();
    Html.EJ()
        .Button("btnSaveQuery")
        .Text("Save Query")
        .ShowRoundedCorner(true)
        .Type(ButtonType.Button)
        .Size(ButtonSize.Medium)
        .ContentType(ContentType.TextAndImage)
        .PrefixIcon("e-icon e-save")
        .Enabled(false)
        .ClientSideEvents(e => e.Click("onSaveQueryClick"))
        .Render();
    Html.EJ()
        .Dialog("dialogSaveQuery")
        .Title("Save query")
        .ShowOnInit(false)
        .Width("auto")
        .ContentTemplate(
        @<text>
            <div class="row">
                <div class="col-md-12">
                    @(Html.EJ()
                        .MaskEdit("editSaveName")
                        .WatermarkText("Name")
                        .Width("300px")
                        .ClientSideEvents(ev => ev.Change("onSaveNameChange"))
                    )
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    @Html.EJ().MaskEdit("SaveDescription").WatermarkText("Description").Width("500px")
                </div>
            </div>
            <div class="row ErrorRow">
                <div class="col-md-12" id="SaveError">
                </div>
            </div>
            <div class="row ButtonRow">
                <div class="col-md-12">
                    @(Html.EJ()
                        .Button("btnSave")
                        .Text("Save")
                        .ShowRoundedCorner(true)
                        .Type(ButtonType.Button)
                        .Size(ButtonSize.Medium)
                        .ContentType(ContentType.TextAndImage)
                        .PrefixIcon("e-icon e-save")
                        .Enabled(false)
                        .ClientSideEvents(e => e.Click("onSaveClick"))
                    )
                </div>
            </div>
        </text>)
        .Render();
    Html.EJ()
        .Button("btnSearch")
        .Text("Search")
        .ShowRoundedCorner(true)
        .Type(ButtonType.Button)
        .Size(ButtonSize.Medium)
        .ContentType(ContentType.TextAndImage)
        .PrefixIcon("e-icon e-search")
        .Enabled(false)
        .ClientSideEvents(e => e.Click("onSearchClick"))
        .Render();
    Html.EJ()
        .Button("btnDownload")
        .Text("Download")
        .ShowRoundedCorner(true)
        .Type(ButtonType.Button)
        .Size(ButtonSize.Medium)
        .ContentType(ContentType.TextAndImage)
        .PrefixIcon("e-icon e-dataexport")
        .Enabled(false)
        .ClientSideEvents(e => e.Click("onDownloadClick"))
        .Render();
}
<script type="text/javascript">
    function onLoadQueryClick() {
        DisableButtons();
        $("#dialogLoadQuery").ejDialog("open");
    }
    function onLoadNameChange() {
        var loadName = $("#editLoadName").val();
        var btnLoad = $("#btnLoad").data("ejButton");
        if (loadName == "") {
            btnLoad.disable()
        }
        else {
            btnLoad.enable()
        }
    }
    function onLoadClick() {
        ShowWaiting();
        $.ajax({
            url: "/Query/LoadQuery",
            data: JSON.stringify({
                Name: $("#editLoadName").val()
            }),
            async: false,
            type: "POST",
            contentType: "application/json",
            success: function () {
                // LoadLocations
                // LoadMap
                // LoadFeatures
                // DataQuery
                $("#dialogLoadQuery").ejDialog("close");
                HideWaiting();
                EnableButtons();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                if (errorThrown == "Not Found") {
                    $("#LoadError").text("A query with that name does not exist!");
                    HideWaiting();
                }
                else {
                    ErrorInFunc("Error in onSaveClick Status: " + textStatus + " Error: " + errorThrown);
                }
            }
        });
    }
    function onSaveQueryClick() {
        DisableButtons();
        $("#dialogSaveQuery").ejDialog("open");
    }
    function onSaveNameChange() {
        var saveName = $("#editSaveName").val();
        var btnSave = $("#btnSave").data("ejButton");
        if (saveName == "") {
            btnSave.disable()
        }
        else {
            btnSave.enable()
        }
    }
    function onSaveClick() {
        ShowWaiting();
        $.ajax({
            url: "/Query/SaveQuery",
            data: JSON.stringify({
                Name: $("#editSaveName").val(),
                Description: $("#SaveDescription").val()
            }),
            async: true,
            type: "POST",
            contentType: "application/json"
        })
            .done(function () {
                $("#dialogSaveQuery").ejDialog("close");
                HideWaiting();
                EnableButtons();
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                if (errorThrown == "Conflict") {
                    $("#SaveError").text("A query with that name already exists!");
                    HideWaiting();
                }
                else {
                    ErrorInFunc("Error in onSaveClick Status: " + textStatus + " Error: " + errorThrown);
                }
            });
    }
    function onSearchClick() {
        ShowWaiting();
        var startDate = $("#StartDate").ejDatePicker("instance")._dateValue;
        var endDate = $("#EndDate").ejDatePicker("instance")._dateValue;
        $.ajax({
            url: "/Query/UpdateFilters",
            data: JSON.stringify({
                StartDate: startDate,
                EndDate: endDate
            }),
            async: false,
            type: "POST",
            contentType: "application/json",
            success: function () {
                $.get("/Query/DataQuery")
                    .done(function () {
                        $.ajax({
                            url: "/Query/GetResultsGridHtml",
                            async: false,
                            type: "GET",
                            success: function (data) {
                                $("#PartialResultsGrid").html(data);
                                $.ajax({
                                    url: "/Query/GetResultsChartHtml",
                                    async: false,
                                    type: "GET",
                                    success: function (data) {
                                        $("#PartialResultsChart").html(data);
                                        HideWaiting();
                                        EnableButtons();
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) {
                                        ErrorInFunc("Error in GetResultsChartHtml Status: " + textStatus + " Error: " + errorThrown)
                                    }
                                });
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                ErrorInFunc("Error in GetResultsGridHtml Status: " + textStatus + " Error: " + errorThrown)
                            }
                        });
                    })
                    .error(function (jqXHR, textStatus, errorThrown) {
                        ErrorInFunc("Error in DataQuery Status: " + textStatus + " Error: " + errorThrown)
                    })
            },
            error: function (jqXHR, textStatus, errorThrown) {
                ErrorInFunc("Error in UpdateFilters Status: " + textStatus + " Error: " + errorThrown);
            }
        })
    }
    function onDownloadClick() {

    }
    function ErrorInFunc(msg) {
        HideWaiting();
        alert(msg);
    }
    function EnableButtons() {
        treeObj = $("#treeViewLocations").data('ejTreeView');
        var checkedNodes = treeObj.getCheckedNodes();
        var selectedLocations = 0
        for (i = 0; i < checkedNodes.length; i++) {
            var checkedNode = checkedNodes[i];
            var nodeData = treeObj.getNode(checkedNode);
            if (nodeData.id.startsWith("STA~")) {
                selectedLocations = selectedLocations + 1;
            }
        }
        treeObj = $("#treeViewFeatures").data('ejTreeView');
        var checkedNodes = treeObj.getCheckedNodes();
        var selectedFeatures = 0
        for (i = 0; i < checkedNodes.length; i++) {
            var checkedNode = checkedNodes[i];
            var nodeData = treeObj.getNode(checkedNode);
            if (nodeData.id.startsWith("OFF~")) {
                selectedFeatures = selectedFeatures + 1;
            }
        }
        var btnLoadQuery = $("#btnLoadQuery").data("ejButton");
        btnLoadQuery.enable();
        var btnSaveQuery = $("#btnSaveQuery").data("ejButton");
        var btnSearch = $("#btnSearch").data("ejButton");
        if ((selectedLocations > 0) & (selectedFeatures > 0)) {
            btnSaveQuery.enable();
            btnSearch.enable();
        }
        else {
            btnSaveQuery.disable();
            btnSearch.disable();
        }
        var btnDownload = $("#btnDownload").data("ejButton");
        btnDownload.disable();
    }
    function DisableButtons() {
        var btnLoadQuery = $("#btnLoadQuery").data("ejButton");
        btnLoadQuery.disable();
        var btnSaveQuery = $("#btnSaveQuery").data("ejButton");
        btnSaveQuery.disable();
        var btnSearch = $("#btnSearch").data("ejButton");
        btnSearch.disable();
        var btnDownload = $("#btnDownload").data("ejButton");
        btnDownload.disable();
    }
</script>
